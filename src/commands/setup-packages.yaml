# src/commands/setup-packages.yaml
# yamllint disable rule:line-length
---

description: >
  Install specified package versions on executor. Keep in mind that the install
  will use sudo since it assumes the executor container is expected to
  running as a defined USER.


parameters:

  terraform-version:
    description: optional override to a specific release version of terraform
    type: string
    default: ""

  checkov-version:
    description: optional override to a specific release version of checkov
    type: string
    default: ""

  tfsec-version:
    description: optional override to a specific release version of tfsec
    type: string
    default: ""

  snyk-version:
    description: optional override to a specific release version of snyk
    type: string
    default: ""

steps:
  - when:
      condition: << parameters.terraform-version >>
      steps:
        - run:
            name: install terraform version << parameters.terraform-version >>
            command: |
              curl -SLO "https://releases.hashicorp.com/terraform/<< parameters.terraform-version >>/terraform_<< parameters.terraform-version >>_linux_amd64.zip"
              sudo unzip -o "terraform_<< parameters.terraform-version >>_linux_amd64.zip" -d /usr/local/bin
  - when:
      condition: << parameters.checkov-version >>
      steps:
        - run:
            name: install checkov version << parameters.checkov-version >>
            command: sudo pip install --no-cache-dir --break-system-packages checkov==<< parameters.checkov-version >>
  - when:
      condition: << parameters.tfsec-version >>
      steps:
        - run:
            name: install tfsec version << parameters.tfsec-version >>
            command: |
              curl -SLO https://github.com/aquasecurity/tfsec/releases/download/v<< parameters.tfsec-version >>/tfsec-checkgen-linux-amd64
              chmod +x tfsec-checkgen-linux-amd64
              sudo mv tfsec-checkgen-linux-amd64 /usr/local/bin/tfsec
  - when:
      condition: << parameters.snyk-version >>
      steps:
        - run:
            name: install snyk version << parameters.snyk-version >>
            command: |
              SNYK_SIGNING_KEY=A22665FB96CAB0E0973604C83676C4B8289C296E
              SNYK_PACKAGE_NAME=$(cat /etc/os-release | grep -q alpine && echo "snyk-alpine" || echo "snyk-linux")
              gpg --keyserver hkps://keys.openpgp.org --recv-keys "${SNYK_SIGNING_KEY}"
              curl -sSLO "https://static.snyk.io/cli/v<< parameters.snyk-version >>/${SNYK_PACKAGE_NAME}" && \
              curl -sSLO "https://static.snyk.io/cli/v<< parameters.snyk-version >>/sha256sums.txt.asc" && \
              gpg --verify sha256sums.txt.asc && grep "${SNYK_PACKAGE_NAME}\$" sha256sums.txt.asc | sha256sum -c - && sudo rm sha256sums.txt.asc && \
              chmod +x "${SNYK_PACKAGE_NAME}" && sudo mv "${SNYK_PACKAGE_NAME}" /usr/local/bin/snyk

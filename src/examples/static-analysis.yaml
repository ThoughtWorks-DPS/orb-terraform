# src/examples/static-analysis.yaml

description: >
  Separate static analysis job prior to terraform plan using twdps/terraform orb.
  Use this to run a single job that will run static analysis and security scanning prior to deployment.
  Use the `static-analysis: false` flag to turn off individual static analysis during the plan jobs.

usage:
  version: 2.1

  orbs:
    terraform: twdps/terraform@0.12.0

  # ==== global pipeline parameters
  globals:
    - &context my-team
    - &shell-options secrethub run -- /bin/sh -eo pipefail
    - &terraform-version 1.0.6
    - &snyk-org my-snyk-org

  # ==== triggers

  # git push: deploy sandbox
  on-push-main: &on-push-main
    branches:
      only: /main/
    tags:
      ignore: /.*/

  # git tag: release
  on-tag-main: &on-tag-main
    branches:
      ignore: /.*/
    tags:
      only: /.*/

  commands:

    set-environment:
      description: generate environment credentials and configuration from templates
      parameters:
        env:
          type: string
          default: ''
      steps:
        - run:
            name: set ~/.terraformrc
            command: op inject -i tpl/terraformrc.tpl -o ~/.terraformrc
        - run:
            name: set << parameters.env >> environment variables
            command: op inject -i environments/<< parameters.env >>.auto.tfvars.json.tpl -o << parameters.env >>.auto.tfvars.json

  workflows:
    version: 2
    my-pipeline:

      jobs:
        # git push: deploy sandbox
        - terraform/static-analysis:
            name: static analysis
            context: *context
            shell: *shell-options
            snyk-organization: *snyk-org
            snyk-additional-args: --severity-threshold=high
            before-static-analysis:
              - run:
                  name: setup snyk token
                  command: echo "example of setting up secrets prior to static analysis"
            filters: *on-push-main

        - terraform/plan:
            name: sandbox-change-plan
            context: *context
            shell: *shell-options
            workspace: sandbox
            static-analysis: false
            terraform-version: *terraform-version
            before-terraform:
              - set-environment:
                  env: sandbox
            filters: *on-push-main

        - approve-sandbox-changes:
            type: approval
            requires:
              - sandbox-change-plan
            filters: *on-push-main

        - terraform/apply:
            name: sandbox-change-apply
            context: *context
            shell: *shell-options
            workspace: sandbox
            terraform-version: *terraform-version
            before-terraform:
              - set-environment:
                  env: sandbox
            requires:
              - approve-sandbox-changes
            filters: *on-push-main

        # git tag: deploy preview
        - terraform/plan:
            name: preview-change-plan
            context: *context
            shell: *shell-options
            workspace: preview
            static-analysis: false
            terraform-version: *terraform-version
            before-terraform:
              - set-environment:
                  env: preview
            filters: *on-tag-main

        - approve-preview-changes:
            type: approval
            requires:
              - preview-change-plan
            filters: *on-tag-main

        - terraform/apply:
            name: preview-change-apply
            context: *context
            shell: *shell-options
            workspace: preview
            terraform-version: *terraform-version
            before-terraform:
              - set-environment:
                  env: preview
            requires:
              - approve-preview-changes
            filters: *on-tag-main
